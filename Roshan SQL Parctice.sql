CREATE DATABASE companydb;
USE companydb;

CREATE TABLE department
(dno INT PRIMARY KEY, 
dname VARCHAR(30),
mgrssn INT, 
mgrstartdate DATE);

CREATE TABLE employee
(ssn INT PRIMARY KEY,fname VARCHAR(30),lname VARCHAR(30),address VARCHAR(200),
sex VARCHAR(1),salary INT,superssn INT,dno INT,
FOREIGN KEY (superssn) REFERENCES employee(ssn),
FOREIGN KEY (dno) REFERENCES Department(dno));

ALTER TABLE department ADD CONSTRAINT 
FOREIGN KEY (mgrssn) REFERENCES employee(ssn);

CREATE TABLE dlocation
(dno INT, dloc VARCHAR(1),
PRIMARY KEY(dno,dloc),
FOREIGN KEY (dno) REFERENCES department(dno));

CREATE TABLE project
(pno INT PRIMARY KEY ,
pname VARCHAR(30),
plocation VARCHAR(30),
dno INT,
FOREIGN KEY (dno) REFERENCES department(dno)
);
CREATE TABLE works_on
(
ssn INT, 
pno INT,
hours INT,
PRIMARY KEY(ssn,pno),
FOREIGN KEY (ssn) REFERENCES employee(ssn),
FOREIGN KEY (pno) REFERENCES project(pno)
);



INSERT INTO employee(ssn,fname,lname,address,sex,salary) VALUES 
(1,'Roshan','Aji Cherian','Trivandrum','M',50000),
(2,'Adwaid','M','Kochi','M',50000),
(3,'Vinayak','Naveen','Trivandrum','M',50000),
(4,'Gowri','Arunsha','Trivandrum','F',50000),
(5,'Suryanaryan','Menon','Trivandrum','M',50000);

INSERT INTO department  
(dno,dname,mgrssn,mgrstartdate) VALUES
(1,'CS',1,"2020-05-12"),
(2,'EC',2,"2019-06-08"),
(3,'IT',3,"2020-04-24"),
(4,'EE',4,"2021-05-22"),
(5,'ME',5,"2019-03-15");

INSERT INTO dlocation
(dno,dloc) VALUES
(1,'A'),
(1,'B'),
(1,'C'),
(1,'D'),
(1,'E');

INSERT INTO project(pno,pname,plocation,dno)
VALUES 
(1,'P1','ploc1',1),
(2,'P2','ploc2',2),
(3,'P3','ploc3',1),
(4,'P4','ploc4',1),
(5,'P5','ploc5',2),
(6,'P6','ploc6',3);
INSERT INTO works_on (ssn,pno,hours)
VALUES
(1,1,10),
(2,2,4),
(3,3,5),
(4,4,8),
(5,5,10),
(5,6,10);

UPDATE EMPLOYEE SET SALARY=80000, DNO=1 WHERE SSN=1;
UPDATE EMPLOYEE SET SUPERSSN=1, SALARY=40000, DNO=2 WHERE SSN=2;
UPDATE EMPLOYEE SET SUPERSSN=1, SALARY=85000, DNO=3 WHERE SSN=3;
UPDATE EMPLOYEE SET SUPERSSN=1, SALARY=72000, DNO=4 WHERE SSN=4;
UPDATE EMPLOYEE SET SUPERSSN=1, SALARY=83000, DNO=5 WHERE SSN=5;

SELECT * from employee;
SELECT * from department;
SELECT * from dlocation;
SELECT * from project;
SELECT * from works_on;

ALTER TABLE EMPLOYEE ADD COLUMN DOB DATE;

UPDATE EMPLOYEE SET DOB="1976-02-25" WHERE SSN=1;
UPDATE EMPLOYEE SET DOB="1980-03-16" WHERE SSN=2;
UPDATE EMPLOYEE SET DOB="1955-04-24" WHERE SSN=3;
UPDATE EMPLOYEE SET DOB="1990-12-23" WHERE SSN=4;
UPDATE EMPLOYEE SET DOB="1999-03-04" WHERE SSN=5;

SELECT * FROM EMPLOYEE WHERE DOB BETWEEN "1970-01-01" AND "1990-12-31";

SELECT FNAME,LNAME,TIMESTAMPDIFF(YEAR,DOB,CURDATE()) FROM EMPLOYEE;

SELECT E.FNAME,E.LNAME,D.DNAME FROM EMPLOYEE AS E INNER JOIN DEPARTMENT AS D ON E.DNO=D.DNO WHERE D.DNAME<>"CS";

SELECT E.SSN FROM EMPLOYEE AS E INNER JOIN DEPARTMENT AS D ON E.DNO=D.DNO 
INNER JOIN PROJECT AS P ON D.DNO=P.DNO;

SELECT E.SSN FROM EMPLOYEE AS E WHERE E.SSN NOT IN (
SELECT E.SSN FROM EMPLOYEE AS E INNER JOIN DEPARTMENT AS D ON E.DNO=D.DNO 
INNER JOIN PROJECT AS P ON D.DNO=P.DNO);

SELECT E.FNAME,E.LNAME FROM EMPLOYEE AS E WHERE E.SSN NOT IN (
SELECT E.SSN FROM EMPLOYEE AS E INNER JOIN DEPARTMENT AS D ON E.DNO=D.DNO 
INNER JOIN PROJECT AS P ON D.DNO=P.DNO);

SELECT D.DNAME,COUNT(P.PNO) FROM PROJECT AS P INNER JOIN DEPARTMENT AS D ON D.DNO=P.DNO
GROUP BY (D.DNAME)
ORDER BY(DNAME);

SELECT P.PNO,P.PNAME FROM PROJECT AS P INNER JOIN WORKS_ON AS W ON P.PNO=W.PNO
INNER JOIN DEPARTMENT AS D ON P.DNO=D.DNO WHERE W.HOURS>6 AND D.DNAME="IT";

SELECT E.FNAME FROM EMPLOYEE AS E INNER JOIN DEPARTMENT AS D 
ON E.DNO=D.DNO 
INNER JOIN PROJECT AS P 
ON D.DNO=P.DNO 
GROUP BY (E.FNAME) HAVING COUNT(P.PNO)<=3;
;